<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payform â€” One link. Paid call or deposit.</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#667085;
      --line:#e9eef6;
      --soft:#f4f7ff;
      --heroCut: clamp(320px, 42vh, 520px);
      --card:#ffffff;
      --blue:#2563eb;
      --green:#16a34a;
      --shadow:0 24px 70px rgba(11,18,32,.08);
      --shadow2:0 14px 40px rgba(11,18,32,.06);
      --focus: 0 0 0 4px rgba(37,99,235,.16);

      /* Inner experience (always dark for clarity + consistency) */
      --pane:#0a1020;
      --pane2:#070c18;
      --pText:#e9eefc;
      --pMuted:#a9b3c8;
      --pLine: rgba(255,255,255,.10);
      --pSoft: rgba(255,255,255,.06);
      --pSoft2: rgba(255,255,255,.09);
      --pBlue: rgba(37,99,235,.22);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{background: var(--soft);}
    body{
      margin:0;
      min-height:100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      letter-spacing:-0.01em;
      background: none;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(900px 520px at 50% 86%, rgba(37,99,235,.10), transparent 62%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) var(--heroCut), var(--soft) var(--heroCut), var(--soft) 100%);
    }

    .wrap{max-width:1040px; margin:0 auto; padding:26px 18px 72px}

    header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 2px 28px;}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:-0.02em}
    .mark{
      width:40px; height:40px; border-radius:12px;
      background: rgba(37,99,235,.10);
      border:1px solid rgba(37,99,235,.18);
      display:grid; place-items:center;
      color:var(--blue);
      font-size:16px;
    }
    .brand small{display:block; margin-top:2px; color:var(--muted); font-weight:700; font-size:12px}

    .btn{height:42px;padding:0 14px;border-radius:12px;border:1px solid var(--line);background:transparent;color:var(--text);font-weight:750;cursor:pointer;transition:transform .05s ease, background .16s ease, border-color .16s ease;}
    .btn:hover{background:rgba(120,135,170,.08)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--blue); border-color:transparent; color:#fff; box-shadow: 0 14px 34px rgba(37,99,235,.18)}
    .btn.primary:hover{filter:brightness(.98)}
    .btn:focus{outline:none; box-shadow:var(--focus)}

    .hero{padding:6px 0 18px; text-align:center}
    h1{margin:0; font-size: clamp(34px, 4.6vw, 56px); line-height:1.05; letter-spacing:-0.03em}
    .sub{margin:12px auto 0; max-width: 720px; color:var(--muted); line-height:1.6; font-size:16px}

    .linkbar{margin:18px auto 0;max-width:780px;padding:10px;border-radius:16px;border:1px solid var(--line);background:var(--soft);display:flex;align-items:center;gap:10px;}
    .linkbar input{flex:1;border:0;background:transparent;font-size:14px;color:var(--text);padding:10px 8px;outline:none;min-width:210px;}
    .copy{height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--line);background:var(--card);cursor:pointer;font-weight:800;}
    .copy:hover{background:rgba(120,135,170,.08)}

    .micro{margin:10px auto 0;max-width:780px;display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12px;}
    .dot{width:4px;height:4px;border-radius:99px;background:rgba(120,135,170,.55)}

    .stage{margin-top:34px; display:flex; justify-content:center}

    .phone{
      width:min(460px, 100%);
      border-radius: 30px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(246,248,252,.92), rgba(246,248,252,.60));
      padding:16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{display:flex; align-items:center; justify-content:space-between;padding:6px 6px 12px;color:var(--muted);font-size:12px;gap:10px;}
    .topbar .left{display:flex; align-items:center; gap:8px; min-width: 120px}
    .topbar .center{display:flex; flex-direction:column; align-items:center; gap:6px}

    .viewToggle{display:inline-grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px;border-radius:999px;border:1px solid var(--line);background: rgba(120,135,170,.08);box-shadow: 0 10px 22px rgba(11,18,32,.06);}
    .vt{border:1px solid transparent;background:transparent;color:var(--muted);font:inherit;font-weight:900;font-size:12px;height:30px;padding:0 12px;border-radius:999px;cursor:pointer;transition: background .16s ease, color .16s ease, transform .05s ease;-webkit-tap-highlight-color: transparent;white-space: nowrap;}
    .vt:hover{background: rgba(120,135,170,.10)}
    .vt:active{transform: translateY(1px)}
    .vt.on{background: var(--card);color: var(--text);border-color: rgba(120,135,170,.18);box-shadow: 0 10px 22px rgba(11,18,32,.08);}
    .vt:focus{outline:none; box-shadow: var(--focus)}

    .tnote{font-size:11px; color: rgba(102,112,133,.9); font-weight:750}

    .lock{width:18px;height:18px;border-radius:8px;display:grid;place-items:center;border:1px solid var(--line);background:rgba(120,135,170,.10)}

    /* Top step bars */
    .dots{display:flex; gap:8px; padding:0 6px 14px}
    .pdot{flex:1;height:6px;border-radius:999px;border:1px solid var(--line);background: rgba(120,135,170,.12);overflow:hidden;}
    .pdot > i{display:block;height:100%;width:0%;background: rgba(37,99,235,.85);border-radius:999px;transition: width .25s ease}

    /* Experience pane (always dark) */
    .pane{
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow2);
      height: min(560px, 66vh);
      min-height: 420px;
      overflow:hidden;
      position:relative;
    }
    .pane::before{
      content:"";
      position:absolute;
      inset:0;
      z-index:0;
      background:
        radial-gradient(820px 520px at 50% 10%, rgba(37,99,235,.20), transparent 60%),
        linear-gradient(180deg, var(--pane) 0%, var(--pane2) 100%);
    }

    /* Robust mode switching */
    .pane.mode-chat #formWrap{display:none !important;}
    .pane.mode-chat #chatWrap{display:flex !important;}
    .pane.mode-form #chatWrap{display:none !important;}
    .pane.mode-form #formWrap{display:block !important;}

    #chatWrap, #formWrap{position:relative; z-index:1; height:100%;}

    /* Chat */
    .chat{
      height:calc(100% - 76px);
      display:flex;
      flex-direction:column;
      gap:10px;
      padding:14px;
      overflow:auto;
      scrollbar-width:none;
      color: var(--pText);
    }
    .chat::-webkit-scrollbar{width:0;height:0}

    .msg{display:flex;}
    .msg.bot{justify-content:flex-start;}
    .msg.user{justify-content:flex-end;}

    .bub{
      max-width: 86%;
      border:1px solid var(--pLine);
      border-radius: 16px;
      padding:10px 12px;
      background: var(--pSoft);
      color: var(--pText);
      font-size:14px;
      line-height:1.45;
    }
    .msg.user .bub{background: var(--pBlue); border-color: rgba(37,99,235,.35);}
    .mut{color:var(--pMuted); font-size:12px; margin-top:6px; line-height:1.45}

    .typing{display:inline-flex;gap:6px;align-items:center;padding:10px 12px;border-radius:16px;border:1px solid var(--pLine);background: var(--pSoft);width:fit-content;}
    .typing i{width:6px;height:6px;border-radius:99px;background:rgba(255,255,255,.55);display:inline-block;animation: blink 1.1s infinite}
    .typing i:nth-child(2){animation-delay:.15s}
    .typing i:nth-child(3){animation-delay:.30s}
    @keyframes blink{0%,100%{opacity:.35}50%{opacity:1}}

    .composer{height:76px;border-top:1px solid var(--pLine);background: rgba(255,255,255,.04);padding:12px 14px calc(12px + env(safe-area-inset-bottom));}

    /* Chips */
    .chips{display:flex; gap:10px; flex-wrap:wrap}
    .chips.segment{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px}

    .chip{
      -webkit-appearance:none;appearance:none;
      font:inherit;
      color: var(--pText);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 0 14px;
      height:48px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:950;
      font-size:16px;
      white-space:nowrap;
      cursor:pointer;
      transition: transform .05s ease, background .16s ease, border-color .16s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover{background: rgba(255,255,255,.11)}
    .chip:active{transform: translateY(1px)}
    .chip.primary{background: rgba(37,99,235,.85); border-color: transparent; color:#fff;}
    .chip.ghost{background: transparent; border-color: rgba(255,255,255,.12);}

    /* Form wizard */
    .formShell{height:100%; display:flex; flex-direction:column;}
    .formTop{padding:14px 14px 10px; border-bottom:1px solid var(--pLine); background: rgba(255,255,255,.03);}
    .fwProg{display:flex; gap:8px; align-items:center; justify-content:center;}
    .fwBar{flex:1; height:6px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); overflow:hidden;}
    .fwBar i{display:block; height:100%; width:0%; background: rgba(37,99,235,.85); border-radius:999px; transition: width .2s ease;}

    .formBody{flex:1; overflow:auto; padding:14px; scrollbar-width:none; color:var(--pText);}
    .formBody::-webkit-scrollbar{width:0;height:0}

    .formLabel{color:var(--pMuted); font-size:12px; font-weight:900; letter-spacing:-.01em}

    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    .field{border:1px solid rgba(255,255,255,.12); border-radius:16px; background: rgba(255,255,255,.06); padding:12px; display:flex; flex-direction:column; gap:8px;}
    .field input,.field textarea{width:100%; border:0; outline:none; background:transparent; color:var(--pText); font:inherit; font-weight:850; font-size:14px; resize:none;}
    .field textarea{min-height:44px}

    .opt{border:1px solid rgba(255,255,255,.12); border-radius:16px; background: rgba(255,255,255,.06); padding:12px; display:flex; align-items:center; justify-content:space-between; cursor:pointer; transition: background .16s ease, border-color .16s ease, transform .05s ease;}
    .opt:hover{background: rgba(255,255,255,.09)}
    .opt:active{transform: translateY(1px)}
    .opt .l{display:flex; flex-direction:column; gap:3px}
    .opt .l strong{font-weight:950}
    .opt .l small{color:var(--pMuted); font-weight:750}
    .opt .r{font-weight:950}

    .formFooter{padding:12px 14px calc(12px + env(safe-area-inset-bottom)); border-top:1px solid var(--pLine); background: rgba(255,255,255,.03); display:flex; gap:10px;}
    .fbtn{flex:1; height:46px; border-radius:16px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color:var(--pText); font-weight:950; cursor:pointer; transition: transform .05s ease, background .16s ease;}
    .fbtn:hover{background: rgba(255,255,255,.09)}
    .fbtn:active{transform: translateY(1px)}
    .fbtn.primary{background: rgba(37,99,235,.85); border-color: transparent; color:#fff;}
    .fbtn:disabled{opacity:.45; cursor:not-allowed; transform:none}

    .invoice{border:1px solid rgba(255,255,255,.12); border-radius:16px; background: rgba(255,255,255,.04); padding:12px;}
    .row{display:flex; align-items:center; justify-content:space-between; padding:8px 0; color:var(--pMuted); font-size:13px}
    .row b{color:var(--pText)}
    .sep{height:1px; background: rgba(255,255,255,.10); margin:6px 0}

    .due{margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; border-radius:16px; border:1px solid rgba(37,99,235,.28); background: rgba(37,99,235,.12); padding:10px 12px;}
    .due .k{color:var(--pMuted); font-size:12px; font-weight:800}
    .due .v{font-weight:1000; font-size:16px; color:var(--pText)}

    .policy{margin-top:10px; display:flex; align-items:center; justify-content:center; gap:10px; color:var(--pMuted); font-size:12px;}

    .payBtn{width:100%; height:46px; border-radius:16px; border:1px solid transparent; background: rgba(37,99,235,.85); color:#fff; font-weight:950; font-size:14px; cursor:pointer; transition: transform .05s ease, filter .16s ease;}
    .payBtn:active{transform: translateY(1px)}
    .payBtn:hover{filter:brightness(.98)}

    .toast{position:fixed;left:50%;bottom: calc(22px + env(safe-area-inset-bottom));transform:translateX(-50%);display:none;gap:10px;align-items:center;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background: var(--card);box-shadow: var(--shadow2);color:var(--text);font-size:13px;z-index:50;}
    .toast.show{display:flex; animation: pop .18s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px); opacity:0} to{transform:translateX(-50%) translateY(0); opacity:1}}

    @media (max-width:420px){
      .phone{padding:14px}
      .chips.segment{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="mark">P</div>
        <div>payform<small>booking link â†’ payment</small></div>
      </div>
      <button class="btn primary" id="cta" type="button">Create link</button>
    </header>

    <section class="hero">
      <h1>One link. Paid call or deposit.</h1>
      <div class="sub">Client answers a few questions, picks the right offer, books a time, paysâ€”done.</div>

      <div class="linkbar" role="group" aria-label="Booking link">
        <input id="linkInput" value="https://payform.com/book/yourname" aria-label="Your booking link" />
        <button class="copy" id="copyBtn" type="button">Copy</button>
      </div>

      <div class="micro" aria-label="Trust">
        <span>Secure checkout</span><span class="dot"></span><span>Receipt</span><span class="dot"></span><span>Calendar invite</span><span class="dot"></span><span>Instant notify</span><span class="dot"></span><span>Powered by Stripe</span>
      </div>
    </section>

    <section class="stage" aria-label="Client experience">
      <div class="phone">
        <div class="topbar">
          <div class="left"><div class="lock">ðŸ”’</div><div>payform</div></div>
          <div class="center">
            <div class="viewToggle" aria-label="View mode" title="Same steps. Different layout.">
              <button class="vt on" id="modeChat" type="button">Chat</button>
              <button class="vt" id="modeForm" type="button">Form</button>
            </div>
            <div class="tnote">Same steps â€¢ choose layout</div>
          </div>
          <div>Secure</div>
        </div>

        <div class="dots" aria-label="Progress">
          <div class="pdot"><i id="d0"></i></div>
          <div class="pdot"><i id="d1"></i></div>
          <div class="pdot"><i id="d2"></i></div>
          <div class="pdot"><i id="d3"></i></div>
          <div class="pdot"><i id="d4"></i></div>
        </div>

        <div class="pane mode-chat" id="pane" aria-label="Conversation">
          <div id="chatWrap" style="display:flex; flex-direction:column; height:100%;">
            <div class="chat" id="chat" role="log" aria-live="polite" aria-relevant="additions"></div>
            <div class="composer" id="composer" aria-label="Reply"></div>
          </div>
          <div id="formWrap" style="display:none;"></div>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite">
    <span style="font-weight:950; color:var(--blue)">âœ“</span>
    <span id="toastText">Copied</span>
  </div>

  <script>
    function assert(condition, message){ if(!condition) throw new Error(message || 'Assertion failed'); }

    const toast = document.getElementById('toast');
    const toastText = document.getElementById('toastText');
    let toastTimer;
    function showToast(msg){
      toastText.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>toast.classList.remove('show'), 1200);
    }

    const linkInput = document.getElementById('linkInput');
    document.getElementById('copyBtn').addEventListener('click', async ()=>{
      const t = linkInput.value;
      try{ await navigator.clipboard.writeText(t); showToast('Copied'); }
      catch(e){
        const ta = document.createElement('textarea');
        ta.value = t;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
        showToast('Copied');
      }
    });

    document.getElementById('cta').addEventListener('click', ()=>{
      document.querySelector('.phone').scrollIntoView({behavior:'smooth', block:'center'});
      showToast('Client preview');
    });

    // Wedge: coaches + consultants. Two flows: paid session OR project deposit.
    const flows = [
      'Paid Strategy Call',
      'Project Deposit'
    ];

    const offers = {
      'Paid Strategy Call': [
        {name:'Starter Call', meta:'30 min â€¢ focused', price:150, deposit:150},
        {name:'Deep Dive', meta:'60 min â€¢ roadmap', price:300, deposit:300},
        {name:'Audit + Plan', meta:'90 min â€¢ doc', price:450, deposit:450}
      ],
      'Project Deposit': [
        {name:'Sprint', meta:'4 weeks â€¢ hands-on', price:2000, deposit:500},
        {name:'Systems Setup', meta:'2 weeks â€¢ build', price:1500, deposit:400},
        {name:'Retainer', meta:'Monthly â€¢ priority', price:3000, deposit:1000}
      ]
    };

    const dates = ['Fri 26','Sat 27','Sun 28'];
    const times = ['10:00','11:00','12:00'];

    const chat = document.getElementById('chat');
    const composer = document.getElementById('composer');
    const chatWrap = document.getElementById('chatWrap');
    const formWrap = document.getElementById('formWrap');

    const modeChatBtn = document.getElementById('modeChat');
    const modeFormBtn = document.getElementById('modeForm');
    const pane = document.getElementById('pane');

    let uiMode = 'chat';

    function setMode(mode){
      uiMode = mode;
      const isChat = (mode === 'chat');

      pane.classList.toggle('mode-chat', isChat);
      pane.classList.toggle('mode-form', !isChat);

      modeChatBtn.classList.toggle('on', isChat);
      modeFormBtn.classList.toggle('on', !isChat);

      chatWrap.hidden = !isChat;
      formWrap.hidden = isChat;
      chatWrap.style.display = isChat ? 'flex' : 'none';
      formWrap.style.display = isChat ? 'none' : 'block';

      if(!isChat){ setFormStep(guessFormStep()); }
    }

    document.querySelector('.viewToggle')?.addEventListener('click', (e)=>{
      const t = e.target;
      if(!(t instanceof Element)) return;
      if(t.id === 'modeChat') setMode('chat');
      if(t.id === 'modeForm') setMode('form');
    });

    modeChatBtn.addEventListener('click', ()=>setMode('chat'));
    modeFormBtn.addEventListener('click', ()=>setMode('form'));

    let step = 0; // 0 intake, 1 offer, 2 schedule, 3 invoice, 4 done
    let s = {
      flow:'',
      name:'',
      email:'',
      notes:'',
      pkg:'',
      date: dates[0],
      time: times[0],
      paid:false
    };

    function esc(str){ return (str||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    function money(n){ return '$' + Number(n).toFixed(0); }

    function currentOffers(){
      return offers[s.flow] || [];
    }
    function pkg(){
      const list = currentOffers();
      return list.find(p=>p.name===s.pkg) || list[0];
    }
    function total(){ return pkg()?.price || 0; }
    function dueNow(){ return pkg()?.deposit || 0; }
    function remaining(){ return Math.max(0, total() - dueNow()); }
    function isDepositFlow(){ return remaining() > 0; }
    function dueLabel(){ return isDepositFlow() ? 'Deposit' : 'Session fee'; }

    function setDots(){
      const fills = [0,0,0,0,0];
      for(let i=0;i<5;i++){
        if(i < step) fills[i] = 100;
        if(i === step) fills[i] = 70;
        if(step === 4) fills[i] = 100;
        const el = document.getElementById('d'+i);
        if(el) el.style.width = fills[i] + '%';
      }
    }

    function scrollBottom(){ requestAnimationFrame(()=>{ chat.scrollTop = chat.scrollHeight; }); }

    function addMsg(role, html){
      const m = document.createElement('div');
      m.className = 'msg ' + role;
      const b = document.createElement('div');
      b.className = 'bub';
      b.innerHTML = html;
      m.appendChild(b);
      chat.appendChild(m);
      scrollBottom();
    }

    function addTyping(){
      const m = document.createElement('div');
      m.className = 'msg bot';
      const t = document.createElement('div');
      t.className = 'typing';
      t.innerHTML = '<i></i><i></i><i></i>';
      m.appendChild(t);
      chat.appendChild(m);
      scrollBottom();
      return () => m.remove();
    }

    function bot(text){
      const rm = addTyping();
      setTimeout(()=>{ rm(); addMsg('bot', esc(text)); }, 220);
    }

    function setComposerHTML(html){ composer.innerHTML = html; }

    function chip(label, cls='', attrs=''){ return `<button class="chip ${cls}" type="button" ${attrs}>${esc(label)}</button>`; }

    function chipsUI(labels, onPick, mode=''){
      const cls = (mode==='segment') ? 'chips segment' : 'chips';
      const html = `<div class="${cls}">${labels.map(l=>chip(l,'',`data-v="${esc(l)}"`)).join('')}</div>`;
      setComposerHTML(html);
      composer.querySelectorAll('[data-v]').forEach(btn=>{
        btn.addEventListener('click', ()=>onPick(btn.getAttribute('data-v')));
      });
    }

    function inputUI(placeholder, key, nextLabel='Continue', allowSkip=true){
      setComposerHTML(`
        <div class="chips" style="display:flex; gap:10px; align-items:center;">
          <input id="in" placeholder="${esc(placeholder)}" style="flex:1; height:48px; border-radius:16px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color: var(--pText); padding:0 12px; font-weight:850;" />
          ${chip(nextLabel,'primary','id="go"')}
        </div>
        <div class="chips" style="margin-top:10px;">${allowSkip ? chip('Skip','ghost','id="skip"') : ''}</div>
      `);
      const inp = composer.querySelector('#in');
      const go = composer.querySelector('#go');
      const skip = composer.querySelector('#skip');
      if(inp) inp.focus();

      const submit = () => {
        const val = (inp?.value || '').trim();
        if(val){ s[key] = val; addMsg('user', esc(val)); }
        else { addMsg('user','â€”'); }
        next();
      };

      go?.addEventListener('click', submit);
      inp?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); submit(); } });
      skip?.addEventListener('click', ()=>{ addMsg('user','Skip'); next(); });
    }

    function offersUI(){
      const list = currentOffers();
      if(!list.length){
        setComposerHTML(`<div class="chips">${chip('Restart','ghost','id="r"')}</div>`);
        composer.querySelector('#r')?.addEventListener('click', ()=>start(true));
        return;
      }
      if(!s.pkg) s.pkg = list[0].name;

      setComposerHTML(`
        <div style="display:grid; gap:10px;">
          ${list.map(p=>{
            const on = (s.pkg===p.name)
              ? 'style="border-color: rgba(37,99,235,.45); background: rgba(37,99,235,.18);"'
              : '';
            return `
              <div class="opt" data-pkg="${esc(p.name)}" ${on}>
                <div class="l"><strong>${esc(p.name)}</strong><small>${esc(p.meta)}</small></div>
                <div class="r">${money(p.price)}</div>
              </div>
            `;
          }).join('')}
        </div>
        <div class="chips" style="margin-top:10px;">
          ${chip('Continue','primary','id="go"')}
          ${chip('Back','ghost','id="back"')}
        </div>
      `);

      composer.querySelectorAll('[data-pkg]').forEach(el=>{
        el.addEventListener('click', ()=>{
          s.pkg = el.getAttribute('data-pkg');
          offersUI();
        });
      });
      composer.querySelector('#go')?.addEventListener('click', ()=>{ addMsg('user', esc(s.pkg)); next(); });
      composer.querySelector('#back')?.addEventListener('click', ()=>{ back(); });
    }

    function scheduleUI(which){
      if(which==='date'){
        setComposerHTML(`
          <div class="chips">${dates.map(d=>chip(d,'',`data-date="${esc(d)}"`)).join('')}</div>
          <div class="chips" style="margin-top:10px;">${chip('Back','ghost','id="back"')}</div>
        `);
        composer.querySelectorAll('[data-date]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            s.date = btn.getAttribute('data-date');
            addMsg('user', esc(s.date));
            stage = 'time';
            step = 2; setDots();
            bot('Time?');
            scheduleUI('time');
          });
        });
        composer.querySelector('#back')?.addEventListener('click', ()=>back());
      }else{
        setComposerHTML(`
          <div class="chips">${times.map(t=>chip(t,'',`data-time="${esc(t)}"`)).join('')}</div>
          <div class="chips" style="margin-top:10px;">${chip('Back','ghost','id="back"')}</div>
        `);
        composer.querySelectorAll('[data-time]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            s.time = btn.getAttribute('data-time');
            addMsg('user', esc(s.time));
            next();
          });
        });
        composer.querySelector('#back')?.addEventListener('click', ()=>back());
      }
    }

    function invoiceUI(){
      const p = pkg();
      const label = dueLabel();
      const detail = isDepositFlow() ? 'Deposit applied to total' : 'No surprises';

      addMsg('bot', `
        <div style="font-weight:950; font-size:14px;">Invoice</div>
        <div class="invoice">
          <div class="row"><span>${esc(p.name)}</span><b>${money(p.price)}</b></div>
          <div class="sep"></div>
          <div class="row"><span>Total</span><b>${money(total())}</b></div>
          <div class="due">
            <div>
              <div class="k">Due now</div>
              <div style="font-weight:950; margin-top:2px; color:var(--pText)">${esc(label)}</div>
            </div>
            <div class="v">${money(dueNow())}</div>
          </div>
          <div class="row"><span>Remaining</span><b>${money(remaining())}</b></div>
        </div>
        <div class="policy"><span>Receipt</span><span class="dot"></span><span>Calendar invite</span><span class="dot"></span><span>${esc(detail)}</span></div>
        <div class="policy" style="margin-top:8px;"><span>Reschedule 24h</span><span class="dot"></span><span>Instant confirm</span></div>
      `);

      setComposerHTML(`
        <div class="chips">
          ${chip(isDepositFlow() ? 'Pay deposit' : 'Pay now','primary','id="pay"')}
          ${chip('Back','ghost','id="back"')}
        </div>
      `);

      composer.querySelector('#back')?.addEventListener('click', ()=>back());
      composer.querySelector('#pay')?.addEventListener('click', ()=>{
        addMsg('user', isDepositFlow() ? 'Pay deposit' : 'Pay now');
        showToast('Paid');
        s.paid = true;
        next();
      });
    }

    function doneUI(){
      const p = pkg();
      addMsg('bot', `Booked âœ…<div class="mut">${esc(p.name)} â€¢ ${esc(s.date)} â€¢ ${esc(s.time)}</div>`);
      addMsg('bot', `<div class="policy" style="margin-top:0;"><span>Receipt sent</span><span class="dot"></span><span>Invite sent</span><span class="dot"></span><span>Coach notified</span></div>`);
      setComposerHTML(`<div class="chips">${chip('Restart','ghost','id="r"')}${chip('Done','primary','id="d"')}</div>`);
      composer.querySelector('#r')?.addEventListener('click', ()=>start(true));
      composer.querySelector('#d')?.addEventListener('click', ()=>showToast('Done'));
    }

    /* ---------------- FORM WIZARD ---------------- */
    let formStep = 0; // 0 flow, 1 details, 2 offer, 3 schedule, 4 invoice, 5 done

    function guessFormStep(){
      if(!s.flow) return 0;
      if(!s.name || !s.email) return 1;
      if(!s.pkg) return 2;
      if(!s.date || !s.time) return 3;
      if(!s.paid) return 4;
      return 5;
    }

    function setFormStep(n){
      formStep = Math.max(0, Math.min(5, n));
      const map = [0,0,1,2,3,4];
      step = map[formStep] ?? 0;
      setDots();
      renderForm();
    }

    function setFormProg(){
      const bars = [...formWrap.querySelectorAll('[data-fw]')];
      const idx = Math.min(formStep, 5);
      bars.forEach((b,i)=>{
        const fill = b.querySelector('i');
        if(!fill) return;
        if(i < idx) fill.style.width = '100%';
        else if(i === idx) fill.style.width = '70%';
        else fill.style.width = '0%';
        if(idx === 5) fill.style.width = '100%';
      });
    }

    function renderForm(){
      const p = pkg();
      const prog = `
        <div class="fwProg" aria-label="Progress">
          ${[0,1,2,3,4].map(i=>`<div class="fwBar" data-fw="${i}"><i></i></div>`).join('')}
        </div>
      `;

      let body = '';
      let nextEnabled = true;

      if(formStep === 0){
        body = `
          <div class="formLabel">Choose a flow</div>
          <div class="chips segment" style="margin-top:10px;">
            ${flows.map(v=>chip(v,'',`data-flow="${esc(v)}"`)).join('')}
          </div>
        `;
        nextEnabled = !!s.flow;
      }

      if(formStep === 1){
        body = `
          <div class="grid2">
            <div class="field"><div class="formLabel">Name</div><input id="fName" value="${esc(s.name)}" placeholder="Name" /></div>
            <div class="field"><div class="formLabel">Email</div><input id="fEmail" value="${esc(s.email)}" placeholder="you@domain.com" /></div>
          </div>
          <div class="field" style="margin-top:10px;"><div class="formLabel">Goal (optional)</div><textarea id="fNotes" placeholder="What do you want help with?">${esc(s.notes)}</textarea></div>
        `;
        nextEnabled = !!(s.name && s.email);
      }

      if(formStep === 2){
        const list = currentOffers();
        if(!s.pkg && list.length) s.pkg = list[0].name;
        const cards = list.map(pp=>{
          const on = (pp.name===s.pkg) ? 'style="border-color: rgba(37,99,235,.45); background: rgba(37,99,235,.18);"' : '';
          return `
            <div class="opt" data-fpkg="${esc(pp.name)}" ${on}>
              <div class="l"><strong>${esc(pp.name)}</strong><small>${esc(pp.meta)}</small></div>
              <div class="r">${money(pp.price)}</div>
            </div>
          `;
        }).join('');
        body = `<div style="display:grid; gap:10px;">${cards}</div>`;
        nextEnabled = !!s.pkg;
      }

      if(formStep === 3){
        body = `
          <div class="formLabel">Date</div>
          <div class="chips" style="margin-top:10px;">${dates.map(v=>chip(v,'',`data-date2="${esc(v)}"`)).join('')}</div>
          <div class="formLabel" style="margin-top:14px;">Time</div>
          <div class="chips" style="margin-top:10px;">${times.map(v=>chip(v,'',`data-time2="${esc(v)}"`)).join('')}</div>
        `;
        nextEnabled = !!(s.date && s.time);
      }

      if(formStep === 4){
        const label = dueLabel();
        const detail = isDepositFlow() ? 'Deposit applied to total' : 'No surprises';
        body = `
          <div class="invoice">
            <div class="row"><span>${esc(p.name)}</span><b>${money(p.price)}</b></div>
            <div class="sep"></div>
            <div class="row"><span>Total</span><b>${money(total())}</b></div>
            <div class="due"><div><div class="k">Due now</div><div style="font-weight:950; margin-top:2px; color:var(--pText)">${esc(label)}</div></div><div class="v">${money(dueNow())}</div></div>
            <div class="row"><span>Remaining</span><b>${money(remaining())}</b></div>
            <div class="policy"><span>Receipt</span><span class="dot"></span><span>Invite</span><span class="dot"></span><span>${esc(detail)}</span></div>
            <div style="margin-top:10px;"><button class="payBtn" id="fPay" type="button">${isDepositFlow() ? 'Pay deposit' : 'Pay now'}</button></div>
            <div class="policy"><span>Reschedule 24h</span><span class="dot"></span><span>Instant notify</span></div>
          </div>
        `;
        nextEnabled = false;
      }

      if(formStep === 5){
        body = `
          <div class="policy" style="margin-top:0;"><span>Receipt sent</span><span class="dot"></span><span>Invite sent</span><span class="dot"></span><span>Coach notified</span></div>
          <div class="chips" style="margin-top:14px;">${chip('Restart','ghost','id="fRestart"')}${chip('Done','primary','id="fDone"')}</div>
        `;
      }

      const backDisabled = (formStep === 0);
      const nextLabel = (formStep === 5) ? ' ' : 'Next';

      formWrap.innerHTML = `
        <div class="formShell">
          <div class="formTop">${prog}</div>
          <div class="formBody">${body}</div>
          <div class="formFooter">
            <button class="fbtn" id="fBack" type="button" ${backDisabled?'disabled':''}>Back</button>
            ${formStep === 4
              ? `<button class="fbtn" id="fNext" type="button" disabled style="visibility:hidden">Next</button>`
              : (formStep === 5
                  ? `<button class="fbtn primary" id="fNext" type="button">Restart</button>`
                  : `<button class="fbtn primary" id="fNext" type="button" ${(!nextEnabled)?'disabled':''}>${nextLabel}</button>`)}
          </div>
        </div>
      `;

      setFormProg();

      // binds
      formWrap.querySelectorAll('[data-flow]').forEach(b=>b.addEventListener('click', ()=>{
        s.flow = b.getAttribute('data-flow');
        s.pkg = '';
        setFormStep(1);
      }));

      formWrap.querySelectorAll('[data-fpkg]').forEach(el=>el.addEventListener('click', ()=>{ s.pkg=el.getAttribute('data-fpkg'); renderForm(); }));
      formWrap.querySelectorAll('[data-date2]').forEach(b=>b.addEventListener('click', ()=>{ s.date=b.getAttribute('data-date2'); renderForm(); }));
      formWrap.querySelectorAll('[data-time2]').forEach(b=>b.addEventListener('click', ()=>{ s.time=b.getAttribute('data-time2'); renderForm(); }));

      const fName = formWrap.querySelector('#fName');
      const fEmail = formWrap.querySelector('#fEmail');
      const fNotes = formWrap.querySelector('#fNotes');
      fName?.addEventListener('input', ()=>{ s.name = fName.value; renderForm(); });
      fEmail?.addEventListener('input', ()=>{ s.email = fEmail.value; renderForm(); });
      fNotes?.addEventListener('input', ()=>{ s.notes = fNotes.value; });

      formWrap.querySelector('#fPay')?.addEventListener('click', ()=>{ showToast('Paid'); s.paid = true; setFormStep(5); });
      formWrap.querySelector('#fRestart')?.addEventListener('click', ()=>start(true));
      formWrap.querySelector('#fDone')?.addEventListener('click', ()=>showToast('Done'));

      formWrap.querySelector('#fBack')?.addEventListener('click', ()=>{ setFormStep(formStep - 1); });
      formWrap.querySelector('#fNext')?.addEventListener('click', ()=>{
        if(formStep === 5){ start(true); return; }
        setFormStep(formStep + 1);
      });
    }

    /* ---------------- CHAT FLOW ---------------- */
    let stage = 'flow';

    function start(resetAll=false){
      if(resetAll){
        chat.innerHTML = '';
        step = 0;
        s = { flow:'', name:'', email:'', notes:'', pkg:'', date:dates[0], time:times[0], paid:false };
        stage = 'flow';
      }
      setDots();
      bot('Hi â€” what are we doing today?');
      chipsUI(flows, (v)=>{ s.flow=v; addMsg('user', esc(v)); next(); }, 'segment');
      if(uiMode==='form') renderForm();
    }

    function back(){
      showToast('Back');
      if(stage === 'invoice' || stage === 'time' || stage === 'date'){
        stage = 'offer';
        step = 1;
        setDots();
        bot('Pick an offer');
        offersUI();
        return;
      }
      stage = 'flow';
      step = 0;
      setDots();
      bot('What are we doing today?');
      chipsUI(flows, (v)=>{ s.flow=v; addMsg('user', esc(v)); next(); }, 'segment');
    }

    function next(){
      if(stage === 'flow'){
        stage = 'name';
        step = 0; setDots();
        bot('A few quick questions, then checkout. Name?');
        inputUI('Name', 'name', 'Continue', true);
        return;
      }

      if(stage === 'name'){
        stage = 'email';
        step = 0; setDots();
        bot('Email for receipt + invite?');
        inputUI('you@domain.com', 'email', 'Continue', true);
        return;
      }

      if(stage === 'email'){
        stage = 'notes';
        step = 0; setDots();
        bot('Goal for this session?');
        chipsUI(['Skip','Add goal'], (v)=>{
          addMsg('user', esc(v));
          if(v==='Add goal'){
            inputUI('One sentence', 'notes', 'Save', true);
          }else{
            s.notes='';
            stage = 'offer';
            step = 1; setDots();
            bot('Pick an offer');
            offersUI();
          }
        });
        return;
      }

      if(stage === 'notes'){
        stage = 'offer';
        step = 1; setDots();
        bot('Pick an offer');
        offersUI();
        return;
      }

      if(stage === 'offer'){
        stage = 'date';
        step = 2; setDots();
        bot('Date?');
        scheduleUI('date');
        return;
      }

      if(stage === 'time'){
        stage = 'invoice';
        step = 3; setDots();
        bot('Got it.');
        setTimeout(()=>{
          addMsg('bot', `<div class="mut">${esc(pkg().name)} â€¢ ${esc(s.date)} â€¢ ${esc(s.time)}</div>`);
          invoiceUI();
        }, 180);
        return;
      }

      if(stage === 'invoice'){
        stage = 'done';
        step = 4; setDots();
        doneUI();
        return;
      }
    }

    /* ---------------- TESTS ---------------- */
    function runTests(){
      assert(document.querySelector('.pane'), 'pane missing');
      assert(document.querySelector('#chat'), 'chat missing');
      assert(document.querySelector('#composer'), 'composer missing');
      assert(document.querySelector('#formWrap'), 'formWrap missing');
      assert(document.querySelector('#modeChat') && document.querySelector('#modeForm'), 'mode toggle missing');
      assert(typeof chipsUI === 'function', 'chipsUI missing');
      assert(typeof setMode === 'function', 'setMode missing');
      assert(typeof setDots === 'function', 'setDots missing');

      // Toggle should deterministically switch panes
      setMode('form');
      assert(formWrap.style.display === 'block', 'form mode not visible');
      setMode('chat');
      assert(chatWrap.style.display === 'flex', 'chat mode not visible');

      // Dots should set width
      step = 0; setDots();
      const d0 = document.getElementById('d0');
      assert(d0 && typeof d0.style.width === 'string', 'dot width not set');

      // Form shell should render
      setMode('form');
      assert(formWrap.querySelector('.formShell'), 'form shell missing');
      assert(formWrap.querySelectorAll('[data-fw]').length === 5, 'form progress bars missing');

      // Offer routing should work
      s.flow = flows[0];
      s.pkg = '';
      renderForm();
      const someOffer = (offers[flows[0]]||[])[0];
      assert(!!someOffer, 'offers missing');

      // Restore
      start(true);
      setMode('chat');
      console.log('[Payform prototype] tests passed');
    }

    runTests();
  </script>
</body>
</html>
